<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ДП Ліси України — Панель KPI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
    // CDN library check
    window._libCheck = { xlsx: typeof XLSX !== 'undefined', chart: typeof Chart !== 'undefined', supabase: typeof supabase !== 'undefined' };
    console.log('Libraries:', window._libCheck);
    </script>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/forest-dashboard.css">
</head>
<body>

<div class="bg-mesh"><div class="bg-orb bg-orb--1"></div><div class="bg-orb bg-orb--2"></div><div class="bg-orb bg-orb--3"></div></div>
<div class="bg-grid"></div>

<!-- Auth (on by default - JS hides when session exists) -->
<div class="auth-screen on" id="authScreen">
    <div class="auth-box">
        <h2>ДП Ліси України</h2>
        <div class="auth-subtitle">Панель KPI</div>
        <p>Увійдіть для доступу до панелі</p>
        <input class="auth-input" id="authEmail" type="email" placeholder="Email" autocomplete="email" autofocus>
        <input class="auth-input" id="authPass" type="password" placeholder="Пароль" autocomplete="current-password">
        <button class="auth-btn" id="btnLogin" onclick="handleLogin()">Увійти</button>
        <div class="auth-error" id="authError"></div>
        <div class="auth-loading-overlay" id="authLoadingOverlay">
            <div class="spinner"></div>
            <p>Завантаження профілю...</p>
        </div>
    </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
        <div class="logo-icon">ЛУ</div>
        <span>ДП Ліси України</span>
    </div>
    <div class="sidebar-nav">
        <div class="nav-item active" data-page="volumes" onclick="switchPage('volumes')">
            <svg viewBox="0 0 24 24"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            <span>Обсяги</span>
        </div>
        <div class="nav-item" data-page="finance" onclick="switchPage('finance')">
            <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>Фінанси</span>
        </div>
        <div class="nav-item" data-page="forest" onclick="switchPage('forest')">
            <svg viewBox="0 0 24 24"><path d="M17 20V8l-5-6-5 6v12"/><path d="M12 2L7 8h10l-5-6z"/><path d="M7 8L2 14h5"/><path d="M17 8l5 6h-5"/><line x1="12" y1="14" x2="12" y2="20"/></svg>
            <span>Продукція</span>
        </div>
        <div class="nav-item" data-page="harvesting" onclick="switchPage('harvesting')">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
            <span>Заготівля</span>
        </div>
    </div>
    <div class="sidebar-bottom">
        <button class="theme-btn" onclick="toggleTheme()">
            <svg id="themeIcon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            <span id="themeLbl">Світла тема</span>
        </button>
    </div>
</nav>

<!-- Header -->
<header class="header">
    <div class="header-left">
        <div class="header-title">
            <h1>ДП Ліси України — Панель KPI</h1>
            <p id="hdrSub">Завантажте файл для початку</p>
        </div>
    </div>
    <div class="header-right">
        <div class="user-info" id="userInfo">
            <span class="user-name" id="userName"></span>
            <span class="role-badge" id="roleBadge"></span>
            <button class="btn-logout" onclick="handleLogout()">Вийти</button>
        </div>
        <div id="liveInfo" style="display:none"><span class="live-dot"></span><span style="font-size:11px;color:var(--text2)" id="liveLbl">Live</span></div>
        <button class="btn btn-sm" id="btnExport" style="display:none" onclick="exportExcel()" title="Експорт Excel"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Excel</button>
        <button class="btn btn-sm" id="btnPrint" style="display:none" onclick="window.print()" title="Друк/PDF"><svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Друк</button>
        <label class="btn btn-sm" id="btnUpload" style="display:none"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Завантажити<input type="file" id="fileHdr" accept=".xlsx,.xls"></label>
        <button class="icon-btn" id="btnFormatHelp" style="display:none" onclick="openFormatHelp()" title="Формати файлів"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></button>
        <button class="icon-btn" id="btnTargets" style="display:none" onclick="openTargetModal()" title="Налаштувати цілі"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></button>
        <button class="icon-btn" id="btnViewerAccess" style="display:none" onclick="openViewerAccess()" title="Доступ глядачів"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></button>
        <button class="btn btn-sm btn-danger" id="btnClear" style="display:none" onclick="openDataManage()" title="Керування даними"><svg viewBox="0 0 24 24"><path d="M4 7h16M10 11v6M14 11v6M5 7l1 12a2 2 0 002 2h8a2 2 0 002-2l1-12M9 7V4h6v2"/></svg></button>
    </div>
</header>

<div class="loader" id="loader"><div><div class="spinner"></div><p style="color:var(--text2);font-size:13px">Обробка даних...</p></div></div>
<div class="toast" id="toast"></div>

<main class="main">
    <div class="empty-state" id="empty">
        <div class="drop-zone" id="dropZone">
            <input type="file" id="fileDrop" accept=".xlsx,.xls">
            <div class="drop-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/></svg></div>
            <h2>Завантажте файл з даними</h2>
            <p>Перетягніть Excel або натисніть для вибору.<br>Нові дані додаються до існуючих.</p>
            <span class="ft">.xlsx .xls</span>
        </div>
    </div>

    <div class="dashboard" id="dash">
        <!-- Filter bar -->
        <div class="filter-bar" id="filterBar">
            <div class="filter-group" id="quickFilters">
                <button class="filter-btn" data-p="30">30д</button>
                <button class="filter-btn" data-p="90">90д</button>
                <button class="filter-btn" data-p="365">1 рік</button>
                <button class="filter-btn active" data-p="all">Все</button>
            </div>
            <span class="filter-sep">|</span>
            <select class="filter-select" id="filterYear"><option value="">Рік</option></select>
            <select class="filter-select" id="filterMonth"><option value="">Місяць</option></select>
            <span class="filter-sep">|</span>
            <input type="date" class="filter-date" id="filterFrom" title="Від">
            <span class="filter-sep">—</span>
            <input type="date" class="filter-date" id="filterTo" title="До">
            <button class="filter-reset" id="filterReset" title="Скинути">✕</button>
        </div>

        <div class="stats-bar" id="statsBar"></div>

        <!-- Volumes page -->
        <div class="page-section active" id="pageVolumes">
            <div class="kpi-grid" id="kpiGrid"></div>
            <div class="insights-bar" id="insightsBar"></div>

            <div class="glass chart-card" style="margin-bottom:20px" id="mainChartCard">
                <div class="chart-hdr"><div><h3>Динаміка обсягів</h3><small>Реалізація та заготівля, м³</small></div>
                    <div class="chart-hdr-actions">
                        <div class="toggle" id="tglMain"><button class="active" data-m="both">Обидва</button><button data-m="realized">Реалізація</button><button data-m="harvested">Заготівля</button></div>
                        <button class="icon-btn" onclick="toggleFullscreen('mainChartCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                    </div>
                </div>
                <div class="chart-wrap" id="wrapMain"><canvas id="cMain"></canvas></div>
            </div>

            <div class="chart-row cols-2">
                <div class="glass chart-card" id="monthlyChartCard">
                    <div class="chart-hdr"><div><h3>Місячні обсяги</h3><small>Клікніть по стовпцю для деталей</small></div>
                        <button class="icon-btn" onclick="toggleFullscreen('monthlyChartCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                    </div>
                    <div class="chart-wrap medium" id="wrapMonthly"><canvas id="cMonthly"></canvas></div>
                </div>
                <div class="glass chart-card" id="cumChartCard">
                    <div class="chart-hdr"><div><h3>Накопичувальний підсумок</h3><small>Кумулятивно з початку року</small></div>
                        <button class="icon-btn" onclick="toggleFullscreen('cumChartCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                    </div>
                    <div class="chart-wrap medium" id="wrapCum"><canvas id="cCum"></canvas></div>
                </div>
            </div>

            <div class="chart-row cols-2">
                <div class="glass chart-card" id="yoyChartCard">
                    <div class="chart-hdr"><div><h3>Порівняння по роках</h3><small>Місячні обсяги реалізації</small></div></div>
                    <div class="chart-wrap medium" id="wrapYoy"><canvas id="cYoy"></canvas></div>
                </div>
                <div class="glass chart-card" id="wdChartCard">
                    <div class="chart-hdr"><div><h3>Розподіл по днях тижня</h3><small>Середні обсяги реалізації</small></div></div>
                    <div class="chart-wrap medium" id="wrapWd"><canvas id="cWd"></canvas></div>
                </div>
            </div>

            <div class="glass chart-card" style="margin-bottom:20px">
                <div class="chart-hdr"><div><h3>Детальна таблиця по місяцях</h3></div>
                    <div class="toggle" id="tglTbl"><button class="active" data-t="realized">Реалізація</button><button data-t="harvested">Заготівля</button></div></div>
                <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Місяць</th><th>Обсяг</th><th>Сер./день</th><th>Макс</th><th>Днів</th><th>MoM</th></tr></thead><tbody id="tblBody"></tbody></table></div>
            </div>
        </div>

        <!-- Finance page -->
        <div class="page-section" id="pageFinance">
            <div class="kpi-grid" id="kpiGridFin"></div>
            <div class="glass chart-card" id="cashChartCard" style="margin-bottom:20px">
                <div class="chart-hdr"><div><h3>Надходження грошових коштів</h3><small>Денна динаміка та помісячна агрегація, грн</small></div>
                    <button class="icon-btn" onclick="toggleFullscreen('cashChartCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                </div>
                <div class="chart-wrap" id="wrapCash"><canvas id="cCash"></canvas></div>
            </div>
            <div class="glass chart-card">
                <div class="chart-hdr"><div><h3>Таблиця грошових надходжень</h3></div></div>
                <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Місяць</th><th>Обсяг</th><th>Сер./день</th><th>Макс</th><th>Днів</th><th>MoM</th></tr></thead><tbody id="tblBodyFin"></tbody></table></div>
            </div>
            <div id="finEmptyState" style="display:none;text-align:center;padding:60px 20px;color:var(--text2)">
                <p style="font-size:15px;margin-bottom:8px">Фінансові дані відсутні</p>
                <p style="font-size:12px">Завантажте Excel з даними грошових надходжень</p>
            </div>
        </div>

        <!-- Harvesting filter bar (hidden by default) -->
        <div class="filter-bar" id="harvestingFilterBar" style="display:none">
            <select class="filter-select" id="hOffice"><option value="">Обласне управління</option></select>
            <button class="filter-reset" id="harvestingFilterReset" title="Скинути">✕</button>
        </div>

        <!-- Forest filter bar (hidden by default) -->
        <div class="filter-bar" id="forestFilterBar" style="display:none">
            <select class="filter-select" id="fBranch"><option value="">Філія</option></select>
            <select class="filter-select" id="fRegion"><option value="">Область</option></select>
            <select class="filter-select" id="fProduct"><option value="">Продукція</option></select>
            <select class="filter-select" id="fSpecies"><option value="">Порода</option></select>
            <select class="filter-select" id="fWarehouse"><option value="">Склад</option></select>
            <select class="filter-select" id="fQuality"><option value="">Клас якості</option></select>
            <button class="filter-reset" id="forestFilterReset" title="Скинути">✕</button>
        </div>

        <!-- Forest page -->
        <div class="page-section" id="pageForest">
            <div id="forestEmptyState" style="text-align:center;padding:60px 20px;color:var(--text2)">
                <p style="font-size:15px;margin-bottom:8px">Дані лісопродукції відсутні</p>
                <p style="font-size:12px">Завантажте Excel з середньозваженими цінами або залишками</p>
            </div>

            <div id="forestContent" style="display:none">
                <!-- Prices Section -->
                <div id="pricesSection">
                    <div class="section-title" style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)">Середньозважені ціни</div>
                    <div class="kpi-grid" id="kpiGridPrices"></div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="pricesByProductCard">
                            <div class="chart-hdr"><div><h3>Ціни за продукцією</h3><small>Середньозважена ціна, грн/м³</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('pricesByProductCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapPricesByProduct"><canvas id="cPricesByProduct"></canvas></div>
                        </div>
                        <div class="glass chart-card" id="pricesBySpeciesCard">
                            <div class="chart-hdr"><div><h3>Ціни за породами (Топ-10)</h3><small>Середньозважена ціна, грн/м³</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('pricesBySpeciesCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapPricesBySpecies"><canvas id="cPricesBySpecies"></canvas></div>
                        </div>
                    </div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="pricesByRegionCard">
                            <div class="chart-hdr"><div><h3>Вартість по регіонах</h3><small>Загальна вартість продажів, грн</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('pricesByRegionCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapPricesByRegion"><canvas id="cPricesByRegion"></canvas></div>
                        </div>
                        <div class="glass chart-card" id="volumesByWarehouseCard">
                            <div class="chart-hdr"><div><h3>Обсяги по складах</h3><small>Розподіл обсягів продажів</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('volumesByWarehouseCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapVolumesByWarehouse"><canvas id="cVolumesByWarehouse"></canvas></div>
                        </div>
                    </div>

                    <div class="glass chart-card" style="margin-bottom:20px">
                        <div class="chart-hdr"><div><h3>Таблиця цін</h3></div>
                            <div class="toggle" id="tglPricesTable"><button class="active" data-g="product">Продукція</button><button data-g="species">Порода</button><button data-g="branch">Філія</button></div></div>
                        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Назва</th><th>Обсяг м³</th><th>Сер. ціна</th><th>Вартість</th><th>Позицій</th></tr></thead><tbody id="tblBodyPrices"></tbody></table></div>
                    </div>
                </div>

                <!-- Inventory Section -->
                <div id="inventorySection">
                    <div class="section-title" style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)">Залишки лісопродукції</div>
                    <div class="kpi-grid" id="kpiGridInventory"></div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="invByBranchCard">
                            <div class="chart-hdr"><div><h3>Залишки по філіях</h3><small>Топ-15 філій за обсягом залишків</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('invByBranchCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapInvByBranch"><canvas id="cInvByBranch"></canvas></div>
                        </div>
                        <div class="glass chart-card" id="invByProductCard">
                            <div class="chart-hdr"><div><h3>Залишки за продукцією</h3><small>Розподіл за типом продукції</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('invByProductCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapInvByProduct"><canvas id="cInvByProduct"></canvas></div>
                        </div>
                    </div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="invBySpeciesCard">
                            <div class="chart-hdr"><div><h3>Залишки за породами (Топ-10)</h3><small>Найбільші залишки за видами деревини</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('invBySpeciesCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapInvBySpecies"><canvas id="cInvBySpecies"></canvas></div>
                        </div>
                        <div class="glass chart-card" id="invByWoodGroupCard">
                            <div class="chart-hdr"><div><h3>Залишки за групами порід</h3><small>Розподіл за групами деревини</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('invByWoodGroupCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapInvByWoodGroup"><canvas id="cInvByWoodGroup"></canvas></div>
                        </div>
                    </div>

                    <div class="glass chart-card" style="margin-bottom:20px">
                        <div class="chart-hdr"><div><h3>Таблиця залишків</h3></div>
                            <div class="toggle" id="tglInventoryTable"><button class="active" data-g="branch">Філія</button><button data-g="product">Продукція</button><button data-g="forest_unit">Надлісництво</button></div></div>
                        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Назва</th><th>Залишок м³</th><th>Позицій</th><th>Сер. м³</th></tr></thead><tbody id="tblBodyInventory"></tbody></table></div>
                    </div>
                </div>

                <!-- Combined Analytics Section -->
                <div id="combinedSection">
                    <div class="section-title" style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)">Аналітика: ціна vs залишки</div>
                    <div class="kpi-grid" id="kpiGridCombined" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))"></div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="correlationCard">
                            <div class="chart-hdr"><div><h3>Ціна vs Залишок</h3><small>Bubble: розмір = обсяг продажу</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('correlationCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap" id="wrapCorrelation"><canvas id="cCorrelation"></canvas></div>
                        </div>
                        <div class="glass chart-card">
                            <div class="chart-hdr"><div><h3>Сигнали</h3><small>Породи з високою ціною</small></div></div>
                            <div id="alertsPanel" style="display:flex;flex-direction:column;gap:6px;max-height:350px;overflow-y:auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Harvesting page -->
        <div class="page-section" id="pageHarvesting">
            <div id="harvestingEmptyState" style="text-align:center;padding:60px 20px;color:var(--text2)">
                <p style="font-size:15px;margin-bottom:8px">Дані заготівлі відсутні</p>
                <p style="font-size:12px">Завантажте Excel з планом-фактом або довідкою ЗСУ</p>
            </div>

            <div id="harvestingContent" style="display:none">
                <!-- Plan-Fact Section -->
                <div id="planFactSection">
                    <div class="section-title" style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)">Виконання планових показників заготівлі</div>
                    <div class="kpi-grid" id="kpiGridHarvesting"></div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="planVsActualCard">
                            <div class="chart-hdr"><div><h3>План vs Факт по регіонах</h3><small>Річний план та фактична заготівля, тис м³</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('planVsActualCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapPlanVsActual"><canvas id="cPlanVsActual"></canvas></div>
                        </div>
                        <div class="glass chart-card" id="executionByRegionCard">
                            <div class="chart-hdr"><div><h3>% виконання по регіонах</h3><small>Відсоток виконання річного плану</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('executionByRegionCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapExecutionByRegion"><canvas id="cExecutionByRegion"></canvas></div>
                        </div>
                    </div>

                    <div class="glass chart-card" style="margin-bottom:20px">
                        <div class="chart-hdr"><div><h3>Таблиця план-факт</h3></div></div>
                        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Регіон</th><th>Річний план</th><th>9-міс план</th><th>Заготовлено</th><th>% 9-міс</th><th>% річного</th></tr></thead><tbody id="tblBodyPlanFact"></tbody></table></div>
                    </div>
                </div>

                <!-- ZSU Section -->
                <div id="zsuSection">
                    <div class="section-title" style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)">Вилучення лісопродукції на потреби ЗСУ</div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="zsuByRegionCard">
                            <div class="chart-hdr"><div><h3>ЗСУ по регіонах</h3><small>Відвантажено, м³</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('zsuByRegionCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapZsuByRegion"><canvas id="cZsuByRegion"></canvas></div>
                        </div>
                        <div class="glass chart-card" id="zsuDeclaredVsShippedCard">
                            <div class="chart-hdr"><div><h3>Заявлено vs Відвантажено</h3><small>Порівняння по регіонах, м³</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('zsuDeclaredVsShippedCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapZsuDeclaredVsShipped"><canvas id="cZsuDeclaredVsShipped"></canvas></div>
                        </div>
                    </div>

                    <div class="chart-row cols-2">
                        <div class="glass chart-card" id="zsuProductBreakdownCard">
                            <div class="chart-hdr"><div><h3>Структура ЗСУ</h3><small>Лісопродукція vs Пиломатеріали</small></div>
                                <button class="icon-btn" onclick="toggleFullscreen('zsuProductBreakdownCard')" title="На весь екран"><svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
                            </div>
                            <div class="chart-wrap medium" id="wrapZsuProductBreakdown"><canvas id="cZsuProductBreakdown"></canvas></div>
                        </div>
                        <div class="glass chart-card">
                            <div class="chart-hdr"><div><h3>Таблиця ЗСУ</h3></div></div>
                            <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Регіон</th><th>Лісопр. заявл.</th><th>Лісопр. відвант.</th><th>Вартість</th><th>Пилом. заявл.</th><th>Пилом. відвант.</th><th>Вартість</th></tr></thead><tbody id="tblBodyZsu"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Drill-down modal -->
<div class="modal-overlay" id="drillModal">
    <div class="modal">
        <button class="modal-close" onclick="closeDrillDown()">&times;</button>
        <h3 id="drillTitle">Деталі за місяць</h3>
        <div class="chart-wrap" id="wrapDrill"><canvas id="cDrill"></canvas></div>
    </div>
</div>

<!-- Target modal -->
<div class="modal-overlay" id="targetModal">
    <div class="modal" style="max-width:450px">
        <button class="modal-close" onclick="closeTargetModal()">&times;</button>
        <h3>Налаштування цілей</h3>
        <div class="target-input"><label>Денний план (м³)</label><input type="number" id="tgtDaily" placeholder="напр. 1000"></div>
        <div class="target-input"><label>Місячний план (м³)</label><input type="number" id="tgtMonthly" placeholder="напр. 25000"></div>
        <div class="target-input"><label>Денний план (грн)</label><input type="number" id="tgtCashDaily" placeholder="напр. 500000"></div>
        <button class="btn" style="margin-top:16px" onclick="saveTargets()">Зберегти</button>
    </div>
</div>

<!-- Format help modal -->
<div class="modal-overlay" id="formatHelpModal">
    <div class="modal" style="max-width:550px">
        <button class="modal-close" onclick="closeFormatHelp()">&times;</button>
        <h3>Підтримувані формати файлів</h3>
        <div style="margin-bottom:16px">
            <div style="font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">1. KPI дані (Обсяги, Фінанси)</div>
            <div style="font-size:12px;color:var(--text2);line-height:1.6;padding-left:12px">
                Excel з колонками: <b>Дата</b>, <b>Показник</b>, <b>Значення</b>, Одиниця<br>
                Нові дані додаються до існуючих. Дублікати (за датою та показником) пропускаються.
            </div>
        </div>
        <div style="margin-bottom:16px">
            <div style="font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">2. Середньозважені ціни</div>
            <div style="font-size:12px;color:var(--text2);line-height:1.6;padding-left:12px">
                Excel з колонками: Філія, Область, Склад, Продукція, Порода, Клас якості, Об'єм, Ціна, Вартість<br>
                Дані повністю замінюються при кожному завантаженні.
            </div>
        </div>
        <div style="margin-bottom:16px">
            <div style="font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">3. Залишки лісопродукції</div>
            <div style="font-size:12px;color:var(--text2);line-height:1.6;padding-left:12px">
                Excel вивантажений з ЕОД (система обліку).<br>
                Дані повністю замінюються при кожному завантаженні.
            </div>
        </div>
        <div style="margin-bottom:16px">
            <div style="font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">4. План-факт заготівлі</div>
            <div style="font-size:12px;color:var(--text2);line-height:1.6;padding-left:12px">
                Excel «Виконання планових показників заготівлі» з регіональними обласними управліннями.<br>
                Дані повністю замінюються при кожному завантаженні.
            </div>
        </div>
        <div style="margin-bottom:16px">
            <div style="font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">5. Довідка ЗСУ</div>
            <div style="font-size:12px;color:var(--text2);line-height:1.6;padding-left:12px">
                Excel «Довідка по вилученню лісопродукції на потреби ЗСУ».<br>
                Дані повністю замінюються при кожному завантаженні.
            </div>
        </div>
        <div style="font-size:11px;color:var(--text3);padding:10px;background:rgba(74,157,111,0.06);border-radius:8px;border:1px solid rgba(74,157,111,0.1)">
            Формат файлу визначається автоматично за заголовками таблиці.
        </div>
    </div>
</div>

<!-- Viewer Access modal -->
<div class="modal-overlay" id="viewerAccessModal">
    <div class="modal" style="max-width:550px">
        <button class="modal-close" onclick="closeViewerAccess()">&times;</button>
        <h3>Налаштування доступу глядачів</h3>
        <div id="viewerAccessList"></div>
        <button class="btn" style="margin-top:16px" onclick="saveViewerAccess()">Зберегти</button>
    </div>
</div>

<!-- Data Management modal -->
<div class="modal-overlay" id="dataManageModal">
    <div class="modal" style="max-width:600px">
        <button class="modal-close" onclick="closeDataManage()">&times;</button>
        <h3>Керування даними</h3>
        <div id="dataManageContent">
            <p style="color:var(--text3);font-size:12px">Завантаження...</p>
        </div>
    </div>
</div>

<script type="module" src="js/app.js"></script>

<!-- Mobile Bottom Nav -->
<nav class="mobile-nav" id="mobileNav">
    <div class="mobile-nav-inner">
        <button class="mobile-nav-item active" data-page="volumes" onclick="switchPage('volumes')">
            <svg viewBox="0 0 24 24"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            <span>Обсяги</span>
        </button>
        <button class="mobile-nav-item" data-page="finance" onclick="switchPage('finance')">
            <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>Фінанси</span>
        </button>
        <button class="mobile-nav-item" data-page="forest" onclick="switchPage('forest')">
            <svg viewBox="0 0 24 24"><path d="M17 20V8l-5-6-5 6v12"/><line x1="12" y1="14" x2="12" y2="20"/></svg>
            <span>Продукція</span>
        </button>
        <button class="mobile-nav-item" data-page="harvesting" onclick="switchPage('harvesting')">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
            <span>Заготівля</span>
        </button>
        <button class="mobile-nav-item" onclick="openMobileUpload()">
            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <span>Дані</span>
        </button>
        <button class="mobile-nav-item" onclick="toggleTheme()">
            <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            <span>Тема</span>
        </button>
    </div>
</nav>

</body>
</html>
